<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SMART FHIR Demo Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #patient, #meds, #obs { font-family: monospace; white-space: pre; height: 25vh; overflow: auto; border: 1px solid #CCC; }
    canvas { width: 100%; height: 300px; }
  </style>
</head>
<body>
  <h2>SMART on FHIR Dashboard</h2>
  <h3>Current Patient</h3>
  <div id="patient">Loading...</div>
  <h3>Medications</h3>
  <div id="meds">Loading...</div>
  <h3>Recent Observations (e.g., Glucose / Blood Pressure)</h3>
  <div id="obs">Loading...</div>
  <canvas id="chart"></canvas>

  <script>
  FHIR.oauth2.ready().then(async function(client) {
    try {
      const pt = await client.patient.read();
      document.getElementById("patient").innerText = JSON.stringify(pt, null, 2);

      const meds = await client.request(`/MedicationRequest?patient=${client.patient.id}`, { resolveReferences: ["medicationReference"], graph: true });
      document.getElementById("meds").innerText = JSON.stringify(meds.entry || [], null, 2);

      const obs = await client.request(`/Observation?patient=${client.patient.id}&_count=20&_sort=-date`);
      document.getElementById("obs").innerText = JSON.stringify(obs.entry || [], null, 2);

      // Extract data for chart
      const labels = [];
      const values = [];
      (obs.entry || []).forEach(e => {
        const o = e.resource;
        if (o.valueQuantity) {
          labels.push(o.effectiveDateTime || o.issued);
          values.push(o.valueQuantity.value);
        }
      });

      if (labels.length && values.length) {
        const ctx = document.getElementById('chart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: { labels: labels.reverse(), datasets: [{ label: 'Recent Observation', data: values.reverse(), borderColor: 'teal', fill: false }] },
          options: { responsive: true, scales: { x: { title: { display: true, text: 'Date' }}, y: { title: { display: true, text: 'Value' }}}}
        });
      }
    } catch (e) {
      console.error(e);
      document.getElementById("obs").innerText = e.stack;
    }
  });
  </script>
</body>
</html>